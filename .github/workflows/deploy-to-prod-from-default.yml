name: Deploy to Prod

on:
  push:
    branches:
      - master
  
jobs:
  deploy-to-prod:
    runs-on: self-hosted
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Deploy
        run: |
          helmfile cache cleanup && helmfile apply --suppress-diff --namespace  ${{ secrets.INNER_CIRCLE_PROD_NAMESPACE }} -f deploy/helmfile.yaml \
          --state-values-set global.postgresql.auth.postgresPassword="$INNER_CIRCLE_PROD_POSTGRES_PASSWORD" > /dev/null 2>&1
        env:
          INNER_CIRCLE_PROD_LETS_ENCRYPT_EMAIL: ${{ secrets.INNER_CIRCLE_PROD_LETS_ENCRYPT_EMAIL }}
          INNER_CIRCLE_PROD_POSTGRES_PASSWORD: ${{ secrets.INNER_CIRCLE_PROD_POSTGRES_PASSWORD }}
